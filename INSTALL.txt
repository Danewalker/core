Ophal installation instructions
===============================

This document is just a brief. For a comprenhensive installation guide please
refer to the online Ophal manual: http://ophal.org/manual.

1. Server configuration
This instructions assume that you installed Ophal at /var/www/ophal.

Ophal can run on native Nginx's HttpLuaModule or as a humble CGI script on
Apache, Lighttpd and others that support CGI and URL rewriting. FastCGI support
can be implemented with a FastCGI wrapper on Apache, Nginx, Lighttpd and several
other web servers.

== Apache
Enable mod_rewrite and mod_cgi, then use following configuration for reference:

=== Sub-directory
  Alias /lua /var/www/ophal/
        <Directory "/var/www/ophal">
                AllowOverride All
                Options Indexes FollowSymLinks MultiViews +ExecCGI
                Order allow,deny
                Allow from all
        </Directory>

=== Virtualhost
<VirtualHost *:80>
        ServerAlias ophal

        DocumentRoot /var/www/ophal
        <Directory />
                Options FollowSymLinks
                AllowOverride None
        </Directory>
        <Directory /var/www/ophal/>
                Options Indexes FollowSymLinks MultiViews +ExecCGI
                AllowOverride All
                Order allow,deny
                allow from all
        </Directory>

        ErrorLog /var/log/apache2/ophal-error.log

        # Possible values include: debug, info, notice, warn, error, crit,
        # alert, emerg.
        LogLevel debug

        CustomLog /var/log/apache2/ophal-access.log combined

</VirtualHost>

== Lighttpd
Install mod_magnet and use the file lighttpd.ophal.lua to configure your
server. Also, enable module cgi. Then use following configuration for reference:

$HTTP["host"] =~ ".+\.ophal" {
  evhost.path-pattern = "/var/www/%_/"
  index-file.names = ("index.cgi")
  cgi.assign = ( ".cgi" => "/usr/local/bin/luajit" )
  magnet.attract-physical-path-to = ("/etc/lighttpd/lighttpd.ophal.lua")
}

Notice that configuration above assumes that you are using "luajit".

== Nginx
Install HttpLuaModule and use the file nginx.ophal.conf to configure your server.
Make sure to set 'server_name' and 'root' correctly.


2. Dependencies
== LuaJIT or Lua?
Ophal uses Lua 5.1 by default, but is compatible with LuaJIT 2.x if you prefer it.
You need to edit the first line of index.cgi in order to switch interpreter.

== Debian
$ sudo luarocks install lpeg
$ sudo apt-get install uuid-dev
$ sudo luarocks install luuid
$ sudo luarocks install luafilesystem
$ sudo luarocks install luasocket
$ cd /tmp
$ git clone --depth=1 git://github.com/ophal/cgic.git
$ cd cgic && make && sudo make install
$ cd /tmp
$ git clone --depth=1 git://github.com/ophal/seawolf.git
$ sudo mv seawolf /usr/local/share/lua/5.1/


3. Installation wizard
Open your Ophal installation in a web browser, you should be redirected to the Installation
Wizard, follow the instructions. The wizard will check dependencies and ask for configuration
parameters, then will generate a settings.lua for you, copy the text, store as settings.lua
into the same directory of index.cgi, make the desired changes an set it to read-only.

== (Optional) Configure the Content module
Run the following SQL queries in strict order:

CREATE TABLE content(id INTEGER PRIMARY KEY AUTOINCREMENT, user_id UNSIGNED BIG INT, language VARCHAR(12), title VARCHAR(255), teaser TEXT, body TEXT, created UNSIGNED BIG INT, changed UNSIGNED BIG INT, status BOOLEAN, sticky BOOLEAN, comment BOOLEAN, promote BOOLEAN);
CREATE INDEX idx_content_created ON content (created DESC);
CREATE INDEX idx_content_changed ON content (changed DESC);
CREATE INDEX idx_content_frontpage ON content (promote, status, sticky, created DESC);
CREATE INDEX idx_content_title ON content (title);
CREATE INDEX idx_content_user ON content (user_id);

Also, make sure to include enable and configure the User module.

NOTE: Ophal is compatible with SQLite only.

== (Optional) Configure the User module
Run the following SQL queries in strict order:

CREATE TABLE tag(id INTEGER PRIMARY KEY AUTOINCREMENT, name VARCHAR(255));
CREATE UNIQUE INDEX unq_idx_tag_name ON tag (name);
CREATE TABLE field_tag(entity_type VARCHAR(255), entity_id INTEGER, tag_id INTEGER, PRIMARY KEY (entity_type, entity_id, tag_id));

NOTE: Ophal is compatible with SQLite only.

== (Optional) Configure the Tag module
Run the following SQL queries in strict order:

CREATE TABLE field_tag(entity_type VARCHAR(255), entity_id INTEGER, tag_id INTEGER, PRIMARY KEY (entity_type, entity_id, tag_id));
CREATE TABLE tag(id INTEGER PRIMARY KEY AUTOINCREMENT, name VARCHAR(255));
CREATE UNIQUE INDEX unq_idx_tag_name ON tag (name);

Also, make sure to enable and configure the Content module.

NOTE: Ophal is compatible with SQLite only.


4. Send feedback
Whether you successfully installed Ophal or not, please file an issue with your
feedback at https://github.com/ophal/core/issues/new in order to help us improve
the installation instructions and the installer.


-- The Ophal Team

